# Dockerfile for MCP Server
FROM python:3.12-slim AS builder

# Set working directory
WORKDIR /build

# Copy project files
COPY pyproject.toml .
COPY src/ ./src/

# Install dependencies
RUN pip install --no-cache-dir -e "."

# Final stage
FROM python:3.12-slim

# Set labels
LABEL maintainer="your.email@example.com"
LABEL description="AgenticMCP Server (API mode)"

# Create non-root user
RUN useradd -m -u 1000 agenticmcp

# Set working directory
WORKDIR /app

# Copy installed packages from builder
COPY --from=builder /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy application code
COPY src/ ./src/
COPY pyproject.toml .

# Create directory for config
RUN mkdir -p /app/config && \
    chown -R agenticmcp:agenticmcp /app

# Switch to non-root user
USER agenticmcp

# Set environment variables
ENV PYTHONUNBUFFERED=1

# MCP runs via stdio, no exposed ports
# Use: docker run -i --rm -e MCP_API_URL=... -e MCP_JWT_TOKEN=... agenticmcp-mcp

# Run the server
ENTRYPOINT ["python", "-m", "agenticmcp.server"]
